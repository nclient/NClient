name: 'Release: Dev'

on:
  workflow_dispatch:
    inputs:
      version-prefix:
        description: 'Version'
        required: true
      version-patch:
        description: 'Patch number'     
        required: true

env:
  solution: NClient.sln
  release-type: dev
  github-pkgs-source: https://nuget.pkg.github.com/nclient/index.json
      
jobs:
  
  release:
    if: ${{ github.event.inputs.version-prefix }} != '' && ${{ github.event.inputs.version-patch }} != ''
    environment: release-dev
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v2
    - id: release-info
      name: Release info
      uses: ./.github/actions/release-info
      with:
        release-type: ${{ env.release-type }}
        version-prefix: ${{ github.event.inputs.version-prefix }}
        version-patch: ${{ github.event.inputs.version-patch }}
    - name: Push packaget to NuGet
      uses: ./.github/actions/push
      with:
        solution: ${{ env.solution }}
        version-prefix: ${{ steps.release-info.outputs.version-prefix }}
        version-suffix: ${{ steps.release-info.outputs.version-suffix }}
        source: ${{ env.github-pkgs-source }}
        source-api-key: ${{ secrets.GITHUB_TOKEN }}
        needsTag: false
      
  validation:
    needs: release
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v2
    - id: release-info
      name: Release info
      uses: ./.github/actions/release-info
      with:
        release-type: ${{ env.release-type }}
        version-prefix: ${{ github.event.inputs.version-prefix }}
        version-patch: ${{ github.event.inputs.version-patch }}
    - name: Test release
      uses: ./.github/actions/test-release
      with:
        solution: ${{ env.solution }}
        version-prefix: ${{ steps.release-info.outputs.version-prefix }}
        version-suffix: ${{ steps.release-info.outputs.version-suffix }}
        delay: 30s
        custom-source: ${{ env.github-pkgs-source }}
        custom-source-user: nclient
        custom-source-password: ${{ secrets.GITHUB_TOKEN }}
